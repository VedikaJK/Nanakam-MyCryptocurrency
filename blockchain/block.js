const HexToBinary = require('hex-to-binary') ;
const sha256 = require('../util/sha-256');
const {GENESIS_DATA,MINE_Rate} = require('../config');

class Block{
  /*  constructor(timestamp,lastHash,hash,data){
        this.timestamp = timestamp;
        this.lastHash = lastHash;
        this.hash=hash;
        this.data=data;
    }*/
    constructor({timestamp,lastHash,hash,data,nonce,difficulty}){     //this {..} allows to write arguments in any order
        this.timestamp = timestamp;
        this.lastHash = lastHash;
        this.hash=hash;
        this.data=data;
        this.difficulty=difficulty;
        this.nonce=nonce;
        
        
    }
    
    static genesis(){
        return new Block (GENESIS_DATA);
    }
    static mineBlock({lastBlock,data}){

    /*    return new this({timestamp:Date.now(),
        lastHash:lastBlock.hash, data:data}); //a Block  */
        let hash,timestamp;
        const lastHash = lastBlock.hash;
        //const timestamp = Date.now();
        let {difficulty}= lastBlock;  // takes difficulty value of lastBlock
        let nonce = 0;

        do{
            nonce++;
            timestamp = Date.now();
            difficulty = Block.adjustDifficulty({originalBlock: lastBlock,timestamp});
            hash = sha256(timestamp,lastHash,data,difficulty,nonce);
        }while(HexToBinary(hash).substring(0,difficulty)!== ('0'.repeat(difficulty)) );
        
        return new this({timestamp,lastHash,data,difficulty,nonce,hash}); //hash: sha256(timestamp,lastHash,data,difficulty,nonce)});

    }

    static adjustDifficulty({originalBlock,timestamp}){
        const {difficulty} = originalBlock;   // no need to write originalBlock.difficulty

        if (difficulty<1) return 1;
        const difference = timestamp - originalBlock.timestamp;

        if(difference >=MINE_Rate) return difficulty-1;
        return difficulty + 1;
    }
}
 module.exports = Block
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       